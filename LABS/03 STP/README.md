# LAN Redundancy (STP) - LAB

**Топология:**

![Топология](https://github.com/AlexanderRudakov/airudakov_otus_network_engineer_cource/blob/main/LABS/03%20STP/pictures/topology.PNG)

**Таблица адресации:**
| Device        | Interface     | IP Address   | Subnet Mask   |  
| ------------- | ------------- | ----------   | ----------    |  
| S1            | VLAN 1        | 192.168.1.1  | 255.255.255.0 |
| S2            | VLAN 1        | 192.168.1.2  | 255.255.255.0 |
| S3            | VLAN 1        | 192.168.1.3  | 255.255.255.0 |

## Цель

**1. Создание сети и настройка основных параметров устройства.**<br/>
**2. Выбор корневого коммутатора.**<br/>
**3. Наблюдение за процессом выбора протоколом STP порта, исходя из стоимости портов**<br/>
**4. Наблюдение за процессом выбора протоколом STP порта, исходя из приоритета портов**<br/>

## Ход работы:

**1. Создание сети и настройка основных параметров устройства.**<br/>

a. Отключите поиск DNS. В данном случае на всех коммутаторах конфигурация одинаковая
```
!         
no ip domain-lookup
!
```
b. Присвойте имена устройствам в соответствии с топологией.
```
!
hostname S1 
!
```
(***для коммутаторов меняется только окончание S2, S3, соответсвенно***)
c. Назначьте class в качестве зашифрованного пароля доступа к привилегированному режиму.
```
enable secret 5 $1$PAo.$YPOXnLRDunx0AMBcZrsvO0
```
d.	Назначьте cisco в качестве паролей консоли и VTY и активируйте вход для консоли и VTY каналов.
```
!         
line con 0
 password 7 045802150C2E
 logging synchronous
 login    
line aux 0
line vty 0 4
 password 7 104D000A0618
 login    
!    
```
e.	Настройте logging synchronous для консольного канала. 
***См. пункт "d." (logging synchronous)***
f.	Настройте баннерное сообщение дня (MOTD) для предупреждения пользователей о запрете несанкционированного доступа.
```
!         
banner motd ^C
Attention!
Please log out immediately if you are not an authorized administrator!
^C        
!   
```
g.	Задайте IP-адрес, указанный в таблице адресации для VLAN 1 на всех коммутаторах.
### S1
```
!
interface Vlan1
 ip address 192.168.1.1 255.255.255.0
 !
```
### S2
```
!         
interface Vlan1
 ip address 192.168.1.2 255.255.255.0
!   
```
### S3
```
!         
interface Vlan1
 ip address 192.168.1.3 255.255.255.0
!  
```
h.	Скопируйте текущую конфигурацию в файл загрузочной конфигурации.
***Это по сути просто команда `wr`

## Проверка связи
Проверьте способность компьютеров обмениваться эхо-запросами. <br/>
Успешно ли выполняется эхо-запрос от коммутатора S1 на коммутатор S2? ***Да*** <br/>
Успешно ли выполняется эхо-запрос от коммутатора S1 на коммутатор S3? ***Да*** <br/>
Успешно ли выполняется эхо-запрос от коммутатора S2 на коммутатор S3? ***Да*** <br/>
***ping c S1 коммутатора S3***

![ping](https://github.com/AlexanderRudakov/airudakov_otus_network_engineer_cource/blob/main/LABS/03%20STP/pictures/pingS1_S3.PNG)


**2. Выбор корневого коммутатора.**<br/>

***Пример выолнения требований **S1***:

a. Отключите все порты на коммутаторах.<br/>
b. Настройте подключенные порты в качестве транковых.<br/>
c. Включите порты F0/2 и F0/4 на всех коммутаторах.<br/>

![ping](https://github.com/AlexanderRudakov/airudakov_otus_network_engineer_cource/blob/main/LABS/03%20STP/pictures/pingS3_S1.PNG)

d. Отобразите данные протокола **spanning-tree**:

![shspan](https://github.com/AlexanderRudakov/airudakov_otus_network_engineer_cource/blob/main/LABS/03%20STP/pictures/STP_root_switch(1).PNG)

С учетом данных, на скриншоте оветьте на вопросы:

![shspan_info](https://github.com/AlexanderRudakov/airudakov_otus_network_engineer_cource/blob/main/LABS/03%20STP/pictures/sh_span_info.PNG)

**Какой коммутатор является корневым мостом?** 

**S1**.

**Почему этот коммутатор был выбран протоколом spanning-tree в качестве корневого моста?** 

В моей топологии у всех коммутаторов одинаковое значение **Priority**, но у **S1** самое малое значение **mac адреса**.

**Какие порты на коммутаторе являются корневыми портами?** 

Порты с ролью **Root**, которые "смотрят" на **root** коммутатор.

**Какие порты на коммутаторе являются назначенными портами?** 

Порты с ролью **Desg**, порты которые не заблокированны **STP**, но не смотрят на **root коммутатор**. Например, у **root коммутатора** у него все порты в роли **Desg**.

**Какой порт отображается в качестве альтернативного и в настоящее время заблокирован?**

Порты с ролью **Altn**, на **S2** это ```Et1/1```, на **S2** это ```Et0/3, Et1/2, Et1/3```.

**Почему протокол spanning-tree выбрал этот порт в качестве невыделенного (заблокированного) порта?**

У **S3** порты ```Et1/2, Et1/3``` заблокированны, так как у него хуже всех **BPDU** в топологии и хуже чем у **S2** на которого они "смотрят", и у **S3** разблокированным остается только 1 интерфейс который "смотрит" на **root коммутатор**. Со стороны **S2** на **S1** у **S2** заблокирован ```Et1/1``` так как у него больше **interface ID** и чему у ```Et1/0```. Со стороны **S3** на **S1** у **S3** заблокирован интерфейс ```Et0/3``` по той же причине. Стоит отметить что у всех интерфейсов одинакова стоимость **100**, но у **S3** упомянутые выше интерфейсы ```Et1/2, Et1/3``` потому что для них до "рута" будет добраться дороже (через **S2**) это еще одна причина почему они были заблокированны.


**3. Наблюдение за процессом выбора протоколом STP порта, исходя из стоимости портов**<br/>

В отличии от лабораторной работы (указанной в домашнем задании) изменения стоимости портов не приводили к пересчету топологии. Даже при смени стоимости интерфейса, и(или) приоритета порта. 
Даже тогда когда я отключил по одной линии на каждом коммутаторе, перезагрузил их и все равно не произошло изменение в топологии. 
Единственное что вызвало смену топологии это смена приоритета самого коммутатора. 
```spanning-tree vlan 1 priority 28673``` команда была выполнена на коммутаторе **S3**.
Однако, после этого я поменял на коммутаторе **S2** стоимость интерфейса **Et1/3** до 18. И он изменил статус.
Было:
```
Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Et1/1               Root FWD 100       128.6    Shr 
Et1/3               Altn BLK 1500      128.8    Shr 

```

Стало:
```
Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Et1/1               Desg FWD 100       128.6    Shr 
Et1/3               Root FWD 18        128.8    Shr 
```

Из чего я могу сделать вывод, что это возможно поведение виртуального оборудования.

## Вопросы для повторения
	
1.	Какое значение протокол STP использует первым после выбора корневого моста, чтобы определить выбор порта?

Это стоимость портов до рута **Root Path Cost** (Меньшего Root Path Cost.)

2.	Если первое значение на двух портах одинаково, какое следующее значение будет использовать протокол STP при выборе порта?

Наименьшего Bridge ID. 

3.	Если оба значения на двух портах равны, каким будет следующее значение, которое использует протокол STP при выборе порта?

Следующим будет сравниваться Port ID соседа.

 
 ***Все вайлы конфигураций находятся в*** [папке](https://github.com/AlexanderRudakov/airudakov_otus_network_engineer_cource/tree/main/LABS/03%20STP/configs)

# Исправления после замечаний (Часть 1)

![shspan_info](https://github.com/AlexanderRudakov/airudakov_otus_network_engineer_cource/blob/main/LABS/03%20STP/pictures/sh_span_info.PNG)

>В следующей части у вас не получилось пронаблюдать изменение роли порта. К сожалению, вы не отметили, cost какого порта вы меняли. Как видно из алгоритма выше, изменение роли порта с Alt на Desg изменится, если RPC коммутатора S3 станет меньше RPC коммутатора S2, то есть cost на root порту S3 e0/2 (в сторону S1) должен уменьшиться (или увеличиться на аналогичном порту коммутатора S2 e1/0, но тут нужно увеличивать не сильно, т.к. если увеличить его до 201 или больше, то путь S2 - S3 - S1 станет предпочтительнее, чем прямой S2 - S1 и выберется новый root port в сторону S3). Можете попробовать?

1. Для начала я отключил исбыточные порты на **S1```et0/3, et1/1```,S2```et1/1, et1/2```,S3```et0/3, et1/2```**, чтобы былно несколько проще наблюдать изменения состояния портов.
2. До изменения стоимостей на интефейсах было так:
**S1**
```
Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Et0/2               Desg FWD 100       128.3    Shr 
Et1/0               Desg FWD 100       128.5    Shr 
```
**S2**
```
Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Et1/0               Root FWD 100       128.5    Shr 
Et1/3               Desg FWD 110       128.8    Shr 
```
**S3**
```
Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Et0/2               Root FWD 100       128.3    Shr  
Et1/3               Altn BLK 100        64.8    Shr 
```
После изменений стоимости на инерфейсах коммутатора **S3**(до состояния ниже) стало так:
```
Et0/2               Root FWD 1         128.3    Shr  
Et1/3               Desg FWD 10         64.8    Shr 
```
Т.е мной была изменена стоимость на root интерфейсе ```Et0/2``` со 100 едениц до 1. И на интерфейсе ```Et1/3```(который ранее был как ```Altn и в состоянии BLK```) со 100 до 10. У меня получилось пронаблюдать как изменился статус у интерфейса на ```Et1/3 Desg```. 
Тем самым у меня получилось сделать путь до рута предпочтительнее через **S3**, чем **S2**(```Et1/3 Desg```).

Так же я поменял ответ в пункет 3, как было указано для более точного ответа

3.	Если оба значения на двух портах равны, каким будет следующее значение, которое использует протокол STP при выборе порта?

Следующим будет сравниваться Port ID соседа.



***Все вайлы конфигураций находятся в*** [папке](https://github.com/AlexanderRudakov/airudakov_otus_network_engineer_cource/tree/main/LABS/03%20STP/configs) (обновленные)
Так же я сделал экспорт новой версии лабораторной работы.(VPC там потому что у меня почему-то wireshark перестал "захватывать" трафик с портов  и я это чинил)


# Исправления после замечаний (Часть 2)
>Почему протокол spanning-tree выбрал этот порт в качестве невыделенного (заблокированного) порта?
с учетом исправлений в вопросах для повторения (про PortID соседа и вообще про алгоритм выбора).

После того как был выбран **root** коммутатор, то начались "выборы портов" и изначально заблокированным портом был признан порт ```Et1/3```, так произошло потому что BPDU от коммутатора **S3** была хуже чем у **S2**, поскольку BridgeID у коммутатора **S3** больше, чем у **S2**:

**S3**
```
Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)             
           Address     aabb.cc00.3000
```

**S2**
```
Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)
           Address     aabb.cc00.2000
```
Однако, после того как была иземена стоимость интерфейса ```Et1/3``` с 100 (по умолчанию), до 64, на интерфейсе ```Et0/2``` стоимость была изменена до 1, то путь до **root** коммутатора стал "дешевле" с интерфейса ```Et1/3```+```Et0/2``` на **S3** (64+1=65), чем на **S2**  ```Et1/3```+```Et1/0```(110+100=210). 

Поэтому протокол STP увидел это и заблокировал "невыгодный порт" чтобы не создавать петлю. Тем самым манипулируя стоимостями интерфейсов можно назначать нужные нам статусы интерфейсов.


***Все вайлы конфигураций находятся в*** [папке](https://github.com/AlexanderRudakov/airudakov_otus_network_engineer_cource/tree/main/LABS/03%20STP/configs)

# Исправления после замечаний (Часть 3)

>Если помните алгоритм, то при назначении ролей Desg/Alt добавление Cost получающего порта не происходит. Суть тут такая: у каждого коммутатора есть RPC, но т.к. root порт уже выбран, нам не нужно считать стоимость доставки, нам надо просто выбрать какой коммутатор приоритетнее и *потенциально* лучше. Первым шагом мы сравниваем именно RPC коммутаторов, а не возможных путей к Root bridge через них. Свои RPC все коммутаторы рассылают в BPDU, поэтому мы при получении сравниваем полученное значение (без добавления своих cost) со своим. То есть никаких суммирований cost в данном случае не происходит, и именно поэтому изменение cost портов *между коммутаторами* никак на выбор Desg/Alt не влияют, влияет лишь изменение RPC коммутаторов, который является следствием cost на root порту.

>Можете, пожалуйста, отразить этот алгоритм в работе?

На схеме ниже отображен  результат смены статуса интерфейса после изменения стоимости интерфейсов:

![stp_after_portcost_change](https://github.com/AlexanderRudakov/airudakov_otus_network_engineer_cource/blob/main/LABS/03%20STP/pictures/STP_after_port_cost_change.PNG)

Начинается процесс построения дерева за конкретный VLAN с определения Root коммутатора. Для этого коммутаторы начинают обмениваться BPDU сообщениями чтобы сравнить у кого **BridgeID** больше, если он одинаковый то сравниваются **mac адреса** коммутаторов, побеждает тот коммутатор у кого **mac адрес** меньше. В нашей топологии это оказался **S1**. 
Дальше. Наши коммутаторы **S2** и **S3** по интерфейсам которые смотрели на **S1**, т.е по которому они получали лучшую BPDU, они эти интерфейсы помечают как **root**. 
Так же после того как был выбран root коммутатор, то  **S2** и **S3** перестают рассылать свои BPDU (через root порты).
Дальше. Наши коммутаторы **S2** и **S3** начинают обмениваться BPDU через другие активные интерфейсы, только они эти BPDU меняют. А именно:

- В поле **BridgeID**, **S2** или **S3** ставят свой идентификатор
- **PortID** меняются на тот интерфейс с которого они были отправлены.
- **Root Path Cost** вычисляется стоимость за сколько можно добраться до root относительно самих коммутаторов. 
![BridgeIdentifier](https://github.com/AlexanderRudakov/airudakov_otus_network_engineer_cource/blob/main/LABS/03%20STP/pictures/BridgeIdentifier.PNG)

Из данного скриншота видно, что **S2** и **S3** знают одного и того же root(**S1**), а следовательно топология избыточна, а следовательно нужно заблокировать один из портов.

Выбор какой же порт заблокировать осуществляется в следующем порядке:
1. Root Path Cost - у кого из двух портов на коммутаторе **S2** и **S3** она будет больше тот и будет помечен как ```Altn и будет BLK```. Но если оказались одинаковы то переход ко 2му параметру.
2. BridgeID - можно сказать что это mac адрес коммутаторов **S2** и **S3** (у**S2**он лучше так как меньше). Но если оказались одинаковы то переход ко 3му параметру.
3. PortID - так же, у кого меньше тот и интерфейс и лучше и будет помечен как ```Desg FWD``` и будет передавать трафик. 

И в нашем случае изначально RPC одинковый у **S2** и **S3**, а вот BridgeID был лучше у  **S2** и следовательно его интерфейс был помечен как ```Desg FWD```.

Однако после того как было изменение RPC для **S3**, то его интерфейс который ранее было помечен как ```Altn и будет BLK```, стал  ```Desg FWD```.

**Было**

**S2**

```
Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Et1/0               Root FWD 100       128.5    Shr 
Et1/3               Desg FWD 110       128.8    Shr 
```
**S3**
```
Interface           Role Sts Cost      Prio.Nbr Type
------------------- ---- --- --------- -------- --------------------------------
Et0/2               Root FWD 100       128.3    Shr  
Et1/3               Altn BLK 100        64.8    Shr 
```
**Стало**
После изменений стоимости на инерфейсах коммутатора **S3**(до состояния ниже) стало так:
```
Et0/2               Root FWD 1         128.3    Shr  
Et1/3               Desg FWD 10         64.8    Shr 
```
***Все вайлы конфигураций находятся в*** [папке](https://github.com/AlexanderRudakov/airudakov_otus_network_engineer_cource/tree/main/LABS/03%20STP/configs)